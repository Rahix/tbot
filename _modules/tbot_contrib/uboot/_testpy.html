

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tbot_contrib.uboot._testpy &mdash; tbot 0.10.9-5-ga47582c documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5349f25f" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/documentation_options.js?v=8047a51e"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/tbot-logo-white.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">tbot CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../recipes.html">Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../context.html">Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytest.html">pytest Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration.html">Migrating from tbot 0.7.1</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/main.html"><code class="docutils literal notranslate"><span class="pre">tbot</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/log.html"><code class="docutils literal notranslate"><span class="pre">tbot.log</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/machine.html"><code class="docutils literal notranslate"><span class="pre">tbot.machine</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/machine_linux.html"><code class="docutils literal notranslate"><span class="pre">tbot.machine.linux</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/machine_board.html"><code class="docutils literal notranslate"><span class="pre">tbot.machine.board</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/machine_connector.html"><code class="docutils literal notranslate"><span class="pre">tbot.machine.connector</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/machine_shell.html"><code class="docutils literal notranslate"><span class="pre">tbot.machine.shell</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/machine_channel.html"><code class="docutils literal notranslate"><span class="pre">tbot.machine.channel</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/error.html"><code class="docutils literal notranslate"><span class="pre">tbot.error</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/role.html"><code class="docutils literal notranslate"><span class="pre">tbot.role</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/selectable.html"><code class="docutils literal notranslate"><span class="pre">tbot.selectable</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Testcase Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/tc.html"><code class="docutils literal notranslate"><span class="pre">tbot.tc</span></code> - Builtin Testcases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contrib/connector.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.connector</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contrib/gdb.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.gdb</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contrib/gpio.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.gpio</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contrib/linux.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.linux</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contrib/locking.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.locking</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contrib/swupdate.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.swupdate</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contrib/timing.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.timing</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contrib/uboot.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.uboot</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contrib/utils.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.utils</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CONTRIBUTING.html">Contributing to tbot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../LICENSE.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">tbot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tbot_contrib.uboot._testpy</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

           <div itemprop="articleBody">
             
  <h1>Source code for tbot_contrib.uboot._testpy</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">select</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">tbot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tbot</span><span class="w"> </span><span class="kn">import</span> <span class="n">machine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tbot.machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">channel</span><span class="p">,</span> <span class="n">linux</span>

<span class="n">BH</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;BH&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">linux</span><span class="o">.</span><span class="n">LinuxShell</span><span class="p">)</span>

<span class="n">HOOK_SCRIPTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Hook which test/py uses to access the console:</span>
    <span class="s2">&quot;u-boot-test-console&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">#!/usr/bin/env bash</span>

<span class="s2">stty raw -echo</span>

<span class="s2">exec 10&lt;&amp;0</span>
<span class="s2">exec 11&gt;&amp;1</span>

<span class="s2">cat &lt;&amp;10 &gt;</span><span class="si">{fifo_console_send}</span><span class="s2"> &amp;</span>
<span class="s2">cat &lt;</span><span class="si">{fifo_console_recv}</span><span class="s2"> &gt;&amp;11 &amp;</span>

<span class="s2">sleep infinity</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="c1"># Script which tbot uses to &#39;emulate&#39; the console:</span>
    <span class="s2">&quot;tbot-console&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">#!/usr/bin/env bash</span>

<span class="s2">stty raw -echo</span>

<span class="s2">exec 10&lt;&amp;0</span>
<span class="s2">exec 11&gt;&amp;1</span>

<span class="s2"># Open fifos for reading AND writing to make sure that we can</span>
<span class="s2"># never receive EOF (which would happen when no reader fds are open)</span>
<span class="s2">cat &lt;&amp;10 1&lt;&gt;</span><span class="si">{fifo_console_recv}</span><span class="s2"> &amp;</span>
<span class="s2">cat 0&lt;&gt;</span><span class="si">{fifo_console_send}</span><span class="s2"> &gt;&amp;11 &amp;</span>

<span class="s2">sleep infinity</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="c1"># Hook which test/py uses to reset the board</span>
    <span class="s2">&quot;u-boot-test-reset&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">#!/usr/bin/env bash</span>

<span class="s2">echo &quot;RESET&quot; &gt;</span><span class="si">{fifo_commands}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="c1"># Hook which test/py calls to flash U-Boot (unused here)</span>
    <span class="s2">&quot;u-boot-test-flash&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">#!/usr/bin/env bash</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="c1"># Script which tbot uses to listen to incoming commands</span>
    <span class="c1"># (only for triggering resets at the moment)</span>
    <span class="s2">&quot;tbot-commands&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">#!/usr/bin/env bash</span>

<span class="s2"># Open for reading and writing so the fifo can never receive EOF</span>
<span class="s2">cat &lt;&gt;</span><span class="si">{fifo_commands}</span>
<span class="s2"># If something goes wrong, send an invalid command to abort</span>
<span class="s2">echo &quot;FAIL&quot;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="nd">@tbot</span><span class="o">.</span><span class="n">named_testcase</span><span class="p">(</span><span class="s2">&quot;uboot_setup_testhooks&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_testhooks</span><span class="p">(</span>
    <span class="n">bh</span><span class="p">:</span> <span class="n">BH</span><span class="p">,</span> <span class="n">m_console</span><span class="p">:</span> <span class="n">BH</span><span class="p">,</span> <span class="n">m_command</span><span class="p">:</span> <span class="n">BH</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">Channel</span><span class="p">,</span> <span class="n">channel</span><span class="o">.</span><span class="n">Channel</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup u-boot-test-* hook scripts for tbot interaction.</span>

<span class="sd">    The scripts use 3 FIFOs for sending/receiving the console data to/from tbot</span>
<span class="sd">    which in turn communicates with the board.  The third FIFO is used for</span>
<span class="sd">    commands (currently only RESET).</span>

<span class="sd">    This testcase tries to be smart and only rewrite the hooks when something</span>
<span class="sd">    changed.  For this purpose a hash-value is stored on the build-host and</span>
<span class="sd">    checked agains the locally computed one.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># m_console and m_command must not be the same machine</span>
    <span class="k">assert</span> <span class="nb">id</span><span class="p">(</span><span class="n">m_console</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">(</span><span class="n">m_command</span><span class="p">),</span> <span class="s2">&quot;testhook channels must be separate&quot;</span>

    <span class="n">hookdir</span> <span class="o">=</span> <span class="n">bh</span><span class="o">.</span><span class="n">workdir</span> <span class="o">/</span> <span class="s2">&quot;uboot-testpy-tbot&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hookdir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">bh</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;mkdir&quot;</span><span class="p">,</span> <span class="n">hookdir</span><span class="p">)</span>

    <span class="c1"># FIFOs --- {{{</span>
    <span class="n">tbot</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Creating FIFOs ...&quot;</span><span class="p">)</span>

    <span class="c1"># This dict is used for resolving the paths in the scripts later on</span>
    <span class="n">fifos</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">fifoname</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fifo_console_send&quot;</span><span class="p">,</span> <span class="s2">&quot;fifo_console_recv&quot;</span><span class="p">,</span> <span class="s2">&quot;fifo_commands&quot;</span><span class="p">]:</span>
        <span class="n">fifo</span> <span class="o">=</span> <span class="n">hookdir</span> <span class="o">/</span> <span class="n">fifoname</span>
        <span class="n">bh</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;rm&quot;</span><span class="p">,</span> <span class="s2">&quot;-rf&quot;</span><span class="p">,</span> <span class="n">fifo</span><span class="p">)</span>
        <span class="n">bh</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;mkfifo&quot;</span><span class="p">,</span> <span class="n">fifo</span><span class="p">)</span>
        <span class="n">fifos</span><span class="p">[</span><span class="n">fifoname</span><span class="p">]</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">.</span><span class="n">at_host</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span>
    <span class="c1"># }}}</span>

    <span class="c1"># Hook Scripts --- {{{</span>

    <span class="c1"># Generate a hash for the version of the control files</span>
    <span class="n">script_hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">HOOK_SCRIPTS</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">script_hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">script</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
    <span class="n">script_hash</span> <span class="o">=</span> <span class="n">script_hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="n">hashfile</span> <span class="o">=</span> <span class="n">hookdir</span> <span class="o">/</span> <span class="s2">&quot;tbot-scripts.sha256&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">up_to_date</span> <span class="o">=</span> <span class="n">script_hash</span> <span class="o">==</span> <span class="n">hashfile</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">up_to_date</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">up_to_date</span><span class="p">:</span>
        <span class="n">tbot</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Hooks are up to date, skipping deployment ...&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tbot</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Updating hook scripts ...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">scriptname</span><span class="p">,</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">HOOK_SCRIPTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rendered</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fifos</span><span class="p">)</span>
            <span class="p">(</span><span class="n">hookdir</span> <span class="o">/</span> <span class="n">scriptname</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span>
            <span class="n">bh</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;chmod&quot;</span><span class="p">,</span> <span class="s2">&quot;+x&quot;</span><span class="p">,</span> <span class="n">hookdir</span> <span class="o">/</span> <span class="n">scriptname</span><span class="p">)</span>

        <span class="c1"># Write checksum so we don&#39;t re-deploy next time</span>
        <span class="n">hashfile</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">script_hash</span><span class="p">)</span>
    <span class="c1"># }}}</span>

    <span class="n">tbot</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Adding hooks to $PATH ...&quot;</span><span class="p">)</span>
    <span class="n">oldpath</span> <span class="o">=</span> <span class="n">bh</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">)</span>
    <span class="n">bh</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hookdir</span><span class="o">.</span><span class="n">at_host</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">oldpath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">tbot</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Open console &amp; command channels ...&quot;</span><span class="p">)</span>
    <span class="n">chan_console</span> <span class="o">=</span> <span class="n">m_console</span><span class="o">.</span><span class="n">open_channel</span><span class="p">(</span><span class="n">hookdir</span> <span class="o">/</span> <span class="s2">&quot;tbot-console&quot;</span><span class="p">)</span>
    <span class="n">chan_command</span> <span class="o">=</span> <span class="n">m_command</span><span class="o">.</span><span class="n">open_channel</span><span class="p">(</span><span class="n">hookdir</span> <span class="o">/</span> <span class="s2">&quot;tbot-commands&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">chan_console</span><span class="p">,</span> <span class="n">chan_command</span><span class="p">)</span>


<div class="viewcode-block" id="testpy">
<a class="viewcode-back" href="../../../contrib/uboot.html#tbot_contrib.uboot.testpy">[docs]</a>
<span class="nd">@tbot</span><span class="o">.</span><span class="n">named_testcase</span><span class="p">(</span><span class="s2">&quot;uboot_testpy&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">testpy</span><span class="p">(</span>
    <span class="n">uboot_sources</span><span class="p">:</span> <span class="n">linux</span><span class="o">.</span><span class="n">Path</span><span class="p">[</span><span class="n">BH</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">board</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">Board</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">uboot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">BoardUBoot</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">boardenv</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">testpy_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run U-Boot&#39;s test/py test-framework against a tbot-machine.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This function supersedes the old :py:func:`tbot.tc.uboot.testpy`</span>
<span class="sd">        testcase.  Please read the docs below carefully on how to use it.</span>

<span class="sd">    This function is meant to be integrated into a custom testcase for test/py</span>
<span class="sd">    which sets up the environment as needed.  A simple example could look like</span>
<span class="sd">    this:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from tbot_contrib import uboot</span>

<span class="sd">        BOARDENV = r\&quot;&quot;&quot;</span><span class="c1"># Boardenv for xyz board.</span>

        <span class="n">env__net_dhcp_server</span> <span class="o">=</span> <span class="kc">True</span>
        \<span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        @tbot.testcase</span>
<span class="s2">        def run_testpy() -&gt; None:</span>
<span class="s2">            with tbot.ctx.request(tbot.role.BuildHost) as h:</span>
<span class="s2">                # location of the U-Boot sources - these must have been</span>
<span class="s2">                # pre-configured elsewhere (or configured here manually)</span>
<span class="s2">                build_dir = h.workdir / &quot;u-boot-mainline&quot;</span>

<span class="s2">                # subshell for the build environment</span>
<span class="s2">                with h.subshell():</span>
<span class="s2">                    # setup toolchain</span>
<span class="s2">                    h.env(&quot;CROSS_COMPILE&quot;, &quot;arm-linux-&quot;)</span>

<span class="s2">                    # if needed, you could configure sources here</span>
<span class="s2">                    # h.exec0(&quot;make&quot;, &quot;xyz_defconfig&quot;)</span>

<span class="s2">                    uboot.testpy(</span>
<span class="s2">                        build_dir,</span>
<span class="s2">                        boardenv=BOARDENV,</span>
<span class="s2">                        testpy_args=[&quot;--maxfail&quot;, &quot;6&quot;],</span>
<span class="s2">                    )</span>

<span class="s2">    As shown above, the testcase will attempt to instanciate the default board</span>
<span class="s2">    machine from :py:class:`tbot.role.Board` and</span>
<span class="s2">    :py:class:`tbot.role.BoardUBoot`.  If a different board machine should be</span>
<span class="s2">    used, it can be passed in explicitly like this:</span>

<span class="s2">    .. code-block:: python</span>

<span class="s2">        @tbot.testcase</span>
<span class="s2">        def run_testpy() -&gt; None:</span>
<span class="s2">            with tbot.ctx() as cx:</span>
<span class="s2">                h = cx.request(tbot.role.BuildHost)</span>
<span class="s2">                build_dir = ...</span>
<span class="s2">                ...</span>

<span class="s2">                # for demonstration - this is exactly what uboot.testpy()</span>
<span class="s2">                # would do on its own when board and uboot are not passed.</span>
<span class="s2">                b = cx.request(tbot.role.Board)</span>
<span class="s2">                ub = cx.request(tbot.role.BoardUBoot, exclusive=True)</span>

<span class="s2">                uboot.testpy(</span>
<span class="s2">                    build_dir,</span>
<span class="s2">                    board=b,</span>
<span class="s2">                    uboot=ub,</span>
<span class="s2">                    boardenv=BOARDENV,</span>
<span class="s2">                )</span>

<span class="s2">    It is advisable to request the U-Boot machine with ``exclusive=True`` so no</span>
<span class="s2">    other code will attempt interacting with it while testpy is running. This</span>
<span class="s2">    is not a hard requirement, though.</span>

<span class="s2">    :param tbot.machine.linux.Path uboot_sources: Path to the U-Boot sources on</span>
<span class="s2">        the host where test/py should run.  This could, for example, be your</span>
<span class="s2">        build-host.  Importantly, before calling ``testpy()``, you must ensure</span>
<span class="s2">        that these U-Boot sources have been configured appropriately for your</span>
<span class="s2">        board.  ``testpy()`` will make no attempt to do this itself.</span>
<span class="s2">    :param tbot.role.Board board:  Optional board machine if requesting</span>
<span class="s2">        :py:class:`tbot.role.Board` is not enough.  ``uboot`` must also be</span>
<span class="s2">        passed if ``board`` is passed.</span>
<span class="s2">    :param tbot.role.BoardUBoot uboot:  Optional U-Boot machine if requesting</span>
<span class="s2">        :py:class:`tbot.role.BoardUBoot` is not enough.  ``board`` must also be</span>
<span class="s2">        passed if ``uboot`` is passed.</span>
<span class="s2">    :param str boardenv: Optional &quot;boardenv&quot; file contents to configure</span>
<span class="s2">        test/py.  This can, for example, be used to configure where mmc tests</span>
<span class="s2">        can perform test reads.  The individual test implementations in the</span>
<span class="s2">        U-Boot sources document available options.</span>
<span class="s2">    :param list(str) testpy_args: Optional additional args to be passed to the</span>
<span class="s2">        test/py invocation.  For example, you can use ``[&quot;-k&quot;, &quot;mmc&quot;]`` to</span>
<span class="s2">        filter for mmc tests only.  Or ``[&quot;-v&quot;]`` to show the names of all</span>
<span class="s2">        testcases as they are executed (or skipped).</span>

<span class="s2">    .. versionadded:: 0.9.5</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">board</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">uboot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;when passing `board`, `uboot` is also required!&quot;</span>

    <span class="k">with</span> <span class="n">tbot</span><span class="o">.</span><span class="n">ctx</span><span class="p">()</span> <span class="k">as</span> <span class="n">cx</span><span class="p">:</span>
        <span class="n">bh</span> <span class="o">=</span> <span class="n">uboot_sources</span><span class="o">.</span><span class="n">host</span>

        <span class="k">with</span> <span class="n">tbot</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">LabHost</span><span class="p">)</span> <span class="k">as</span> <span class="n">lh</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">lh</span><span class="p">):</span>
                <span class="n">tbot</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;The host we&#39;re using for test/py might&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot; be needed elsewhere during the test run.&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;  Creating a clone...&quot;</span>
                <span class="p">)</span>
                <span class="n">bh</span><span class="p">:</span> <span class="n">BH</span> <span class="o">=</span> <span class="n">cx</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">bh</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Spawn a subshell to not mess up the parent shell&#39;s environment and PWD</span>
        <span class="n">cx</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">bh</span><span class="o">.</span><span class="n">subshell</span><span class="p">())</span>

        <span class="n">m_console</span><span class="p">:</span> <span class="n">BH</span> <span class="o">=</span> <span class="n">cx</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">bh</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>  <span class="c1"># type: ignore</span>
        <span class="n">m_command</span><span class="p">:</span> <span class="n">BH</span> <span class="o">=</span> <span class="n">cx</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">bh</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>  <span class="c1"># type: ignore</span>
        <span class="n">chan_console</span><span class="p">,</span> <span class="n">chan_command</span> <span class="o">=</span> <span class="n">setup_testhooks</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">m_console</span><span class="p">,</span> <span class="n">m_command</span><span class="p">)</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">uboot_sources</span> <span class="o">/</span> <span class="s2">&quot;.config&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="s2">&quot;u-boot does not seem configured (.config is missing)!&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">uboot_sources</span> <span class="o">/</span> <span class="s2">&quot;include&quot;</span> <span class="o">/</span> <span class="s2">&quot;autoconf.mk&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="s2">&quot;include/autoconf.mk is missing!&quot;</span>

        <span class="k">if</span> <span class="n">board</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">board</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">cx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">Board</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">PowerControl</span>
        <span class="p">),</span> <span class="s2">&quot;board does not support power-control!&quot;</span>

        <span class="k">if</span> <span class="n">board</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">uboot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># for type checking</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">uboot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">cx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">BoardUBoot</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">chan_uboot</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">ch</span>

        <span class="n">boardtype</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="k">if</span> <span class="n">boardenv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">boardtype</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tbot-</span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">boardtype_filename</span> <span class="o">=</span> <span class="n">boardtype</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">boardenv_file</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">uboot_sources</span>
                <span class="o">/</span> <span class="s2">&quot;test&quot;</span>
                <span class="o">/</span> <span class="s2">&quot;py&quot;</span>
                <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;u_boot_boardenv_</span><span class="si">{</span><span class="n">boardtype_filename</span><span class="si">}</span><span class="s2">.py&quot;</span>
            <span class="p">)</span>
            <span class="n">boardenv_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">boardenv</span><span class="p">)</span>

        <span class="n">bh</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;cd&quot;</span><span class="p">,</span> <span class="n">uboot_sources</span><span class="p">)</span>
        <span class="n">chan_testpy</span> <span class="o">=</span> <span class="n">cx</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span>
            <span class="n">bh</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="s2">&quot;./test/py/test.py&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--build-dir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--board-type&quot;</span><span class="p">,</span>
                <span class="n">boardtype</span><span class="p">,</span>
                <span class="o">*</span><span class="p">(</span><span class="n">testpy_args</span> <span class="ow">or</span> <span class="p">[]),</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># We have to deal with incoming data on any of the following channels.</span>
        <span class="c1"># The comments denote what needs to be done for each channel:</span>
        <span class="n">readfds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">chan_console</span><span class="p">,</span>  <span class="c1"># Send data to U-Boot</span>
            <span class="n">chan_uboot</span><span class="p">,</span>  <span class="c1"># Send data to chan_console (test/py)</span>
            <span class="n">chan_command</span><span class="p">,</span>  <span class="c1"># Powercycle the board</span>
            <span class="n">chan_testpy</span><span class="p">,</span>  <span class="c1"># Read data so the log-event picks it up</span>
        <span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">readfds</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[])</span>

                <span class="k">if</span> <span class="n">chan_console</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                    <span class="c1"># Send data to U-Boot</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chan_console</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">4096</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chan_uboot</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">chan_uboot</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                    <span class="c1"># Send data to chan_console (test/py)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chan_uboot</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">4096</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chan_console</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">chan_command</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                    <span class="c1"># Powercycle the board</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">chan_command</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">msg</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;RE&quot;</span><span class="p">:</span>
                        <span class="n">b</span><span class="o">.</span><span class="n">poweroff</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">powercycle_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">powercycle_delay</span><span class="p">)</span>
                        <span class="n">b</span><span class="o">.</span><span class="n">poweron</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got unknown command </span><span class="si">{</span><span class="n">msg</span><span class="si">!r}</span><span class="s2">!&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">chan_testpy</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                    <span class="c1"># Read data so the log-event picks it up.  If a</span>
                    <span class="c1"># DeathStringException occurs here, test/py finished and we</span>
                    <span class="c1"># need to properly terminate the LinuxShell.run() context.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">chan_testpy</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">linux</span><span class="o">.</span><span class="n">CommandEndedException</span><span class="p">:</span>
                        <span class="n">chan_testpy</span><span class="o">.</span><span class="n">terminate0</span><span class="p">()</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="c1"># on keyboard interrupt, try to abort test/py</span>
            <span class="n">chan_testpy</span><span class="o">.</span><span class="n">sendcontrol</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
            <span class="n">chan_testpy</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">raise</span></div>

</pre></div>

           </div>
          </div>
    <a href="https://github.com/Rahix/tbot">
        <img style="position: absolute; top: 0; right: 0; border: 0;" decoding="async" width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" loading="lazy" data-recalc-dims="1">
    </a>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Rahix.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>