

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configuration &mdash; tbot 0.10.10-0-g1853255 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5349f25f" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/documentation_options.js?v=e1796f6e"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Recipes" href="recipes.html" />
    <link rel="prev" title="tbot CLI" href="cli.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/tbot-logo-white.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">tbot CLI</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#simple-example">Simple Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#default-roles">Default roles</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-a-lab-host">Configuring a lab-host</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-a-board">Configuring a board</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#serial-console">Serial Console</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-control">Power Control</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-linux-for-a-board">Configuring Linux for a board</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-u-boot-for-a-board">Configuring U-Boot for a board</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-a-custom-linux-boot-sequence">Configuring a custom Linux boot sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-a-board-without-a-serial-console">Configuring a board without a serial console</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="context.html">Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="pytest.html">pytest Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html">Migrating from tbot 0.7.1</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules/main.html"><code class="docutils literal notranslate"><span class="pre">tbot</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/log.html"><code class="docutils literal notranslate"><span class="pre">tbot.log</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/machine.html"><code class="docutils literal notranslate"><span class="pre">tbot.machine</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/machine_linux.html"><code class="docutils literal notranslate"><span class="pre">tbot.machine.linux</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/machine_board.html"><code class="docutils literal notranslate"><span class="pre">tbot.machine.board</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/machine_connector.html"><code class="docutils literal notranslate"><span class="pre">tbot.machine.connector</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/machine_shell.html"><code class="docutils literal notranslate"><span class="pre">tbot.machine.shell</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/machine_channel.html"><code class="docutils literal notranslate"><span class="pre">tbot.machine.channel</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/error.html"><code class="docutils literal notranslate"><span class="pre">tbot.error</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/role.html"><code class="docutils literal notranslate"><span class="pre">tbot.role</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/selectable.html"><code class="docutils literal notranslate"><span class="pre">tbot.selectable</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Testcase Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules/tc.html"><code class="docutils literal notranslate"><span class="pre">tbot.tc</span></code> - Builtin Testcases</a></li>
<li class="toctree-l1"><a class="reference internal" href="contrib/connector.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.connector</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="contrib/gdb.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.gdb</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="contrib/gpio.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.gpio</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="contrib/linux.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.linux</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="contrib/locking.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.locking</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="contrib/swupdate.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.swupdate</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="contrib/timing.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.timing</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="contrib/uboot.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.uboot</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="contrib/utils.html"><code class="docutils literal notranslate"><span class="pre">tbot_contrib.utils</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributing to tbot</a></li>
<li class="toctree-l1"><a class="reference internal" href="LICENSE.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">tbot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Configuration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/configuration.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

           <div itemprop="articleBody">
             
  <section id="configuration">
<span id="id1"></span><h1>Configuration<a class="headerlink" href="#configuration" title="Link to this heading">¶</a></h1>
<p>Configuration in tbot is used to allow reusing testcase code against multiple
target devices.  This works by putting a common interface between the two:
Testcases do not reference concrete machines but instead request access to
certain <em>roles</em>.  The configuration then supplies machine classes which fill
each of these roles.  The component sitting in the middle is tbot’s
<a class="reference internal" href="context.html#context"><span class="std std-ref">Context</span></a>.</p>
<p>tbot comes with a number of pre-defined roles in the <a class="reference internal" href="modules/role.html#module-tbot.role" title="tbot.role"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tbot.role</span></code></a>
module.  These serve as a generic baseline.  In complex environments, it often
makes sense to define custom roles as well.  This will be shown further down on
this page.</p>
<section id="simple-example">
<h2>Simple Example<a class="headerlink" href="#simple-example" title="Link to this heading">¶</a></h2>
<p>For a basic introduction, you can also check out the <a class="reference internal" href="quickstart.html#quickstart"><span class="std std-ref">Quick Start</span></a> guide.
Here, the configuration that was created over there is shown again:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tbot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tbot.machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">board</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">linux</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoard</span><span class="p">(</span><span class="n">connector</span><span class="o">.</span><span class="n">ConsoleConnector</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">Board</span><span class="p">):</span>
    <span class="n">baudrate</span> <span class="o">=</span> <span class="mi">115200</span>
    <span class="n">serial_port</span> <span class="o">=</span> <span class="s2">&quot;/dev/ttyUSB0&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mach</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mach</span><span class="o">.</span><span class="n">open_channel</span><span class="p">(</span><span class="s2">&quot;picocom&quot;</span><span class="p">,</span> <span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baudrate</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register_machines</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyBoard</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">Board</span><span class="p">)</span>
</pre></div>
</div>
<p>This configuration module defines a machine class <code class="docutils literal notranslate"><span class="pre">MyBoard</span></code>.  The magic is
then in the <code class="docutils literal notranslate"><span class="pre">register_machines()</span></code> function:  It will be called to activate
this configuration and its job is to register all machine classes for the
appropriate roles.  One machine class can be registered for multiple roles, but
the other way around is not possible:  Once a role is occupied, further
attempts to register a different machine for it will fail.</p>
</section>
<section id="default-roles">
<h2>Default roles<a class="headerlink" href="#default-roles" title="Link to this heading">¶</a></h2>
<p>As mentioned above, tbot comes with a number of pre-defined roles in the
<a class="reference internal" href="modules/role.html#module-tbot.role" title="tbot.role"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tbot.role</span></code></a> module.  Let’s look at them in more detail.  Further down
on this page, examples for configuring these roles will also be shown.</p>
<ul>
<li><p><a class="reference internal" href="modules/role.html#tbot.role.LabHost" title="tbot.role.LabHost"><code class="xref py py-class docutils literal notranslate"><span class="pre">tbot.role.LabHost</span></code></a>:  This is the “central” host for hardware
interaction.  Usually, this is where commands are executed to toggle board
power and connect to a serial console.  By default (and in most simple
setups), it is simply the localhost.  But it can also be a remote server to
which an SSH connection needs to be established just as well.</p>
<p>It makes sense to structure your tests around this role.  This will allow
configurations to be more flexible in regards to the hardware lab.</p>
</li>
<li><p><a class="reference internal" href="modules/role.html#tbot.role.LocalHost" title="tbot.role.LocalHost"><code class="xref py py-class docutils literal notranslate"><span class="pre">tbot.role.LocalHost</span></code></a>: While the <a class="reference internal" href="modules/role.html#tbot.role.LabHost" title="tbot.role.LabHost"><code class="xref py py-class docutils literal notranslate"><span class="pre">LabHost</span></code></a> is
often the localhost as well, this role is guaranteed to reference the local
machine.  Tests should use it when accessing local data, e.g. files or
binaries which were distributed alongside the testcases.  A common pattern is
to then first copy everything to the lab-host and from there to the target
(or the other direction for downloads).</p></li>
<li><p><a class="reference internal" href="modules/role.html#tbot.role.BuildHost" title="tbot.role.BuildHost"><code class="xref py py-class docutils literal notranslate"><span class="pre">tbot.role.BuildHost</span></code></a>: A role for a build-server.  When builds are
not done locally, testcases can use this role to reference a build server.
Even when this is the localhost in most cases, using the correct role in
tests means that other configurations can easily move to remote builds when
needed.</p></li>
</ul>
<p>The above roles all describe some Linux machines in the environment.  The
following roles describe the actual “device under test” or embedded hardware.</p>
<p>It is important to understand that machines to not necessarily map to separate
physical hardware.  Especially for the embedded boards, it is common to have
multiple machines which access them in different ways.  Access is then often
exclusive between one or the other.</p>
<ul>
<li><p><a class="reference internal" href="modules/role.html#tbot.role.Board" title="tbot.role.Board"><code class="xref py py-class docutils literal notranslate"><span class="pre">tbot.role.Board</span></code></a>: This role describes the “physical” board and how
to access it.  It does <em>not</em> make any assumptions about the software running
on it.  Splitting into hardware and software this way allows reusing the
software configuration across multiple physical boards of the same type in
different environments.  This role should always use the
<a class="reference internal" href="modules/machine_board.html#tbot.machine.board.Board" title="tbot.machine.board.Board"><code class="xref py py-class docutils literal notranslate"><span class="pre">board.Board</span></code></a> shell-class.</p></li>
<li><p><a class="reference internal" href="modules/role.html#tbot.role.BoardUBoot" title="tbot.role.BoardUBoot"><code class="xref py py-class docutils literal notranslate"><span class="pre">tbot.role.BoardUBoot</span></code></a>: This role describes a U-Boot running on the
board.  It is, of course, only needed when your tests need to interact with
U-Boot or custom bootloader commands are needed to boot the system.  This
machine should “grab” the console from the <a class="reference internal" href="modules/role.html#tbot.role.Board" title="tbot.role.Board"><code class="xref py py-class docutils literal notranslate"><span class="pre">tbot.role.Board</span></code></a>
machine.  The common way to do this is using the <code class="xref py py-class docutils literal notranslate"><span class="pre">board.Connector</span></code> connector.</p></li>
<li><p><a class="reference internal" href="modules/role.html#tbot.role.BoardLinux" title="tbot.role.BoardLinux"><code class="xref py py-class docutils literal notranslate"><span class="pre">tbot.role.BoardLinux</span></code></a>: This role describes a Linux running on the
board.  Similar to U-Boot, it should also grab the console from whatever
machine is registered for <a class="reference internal" href="modules/role.html#tbot.role.Board" title="tbot.role.Board"><code class="xref py py-class docutils literal notranslate"><span class="pre">tbot.role.Board</span></code></a>.  In most cases, this
machine will need an initializer which waits for the login prompt and then
logs in.  You can use <a class="reference internal" href="modules/machine_board.html#tbot.machine.board.LinuxBootLogin" title="tbot.machine.board.LinuxBootLogin"><code class="xref py py-class docutils literal notranslate"><span class="pre">board.LinuxBootLogin</span></code></a> for that.</p>
<p>When a custom boot sequence is needed, this machine can also, for example,
acquire the <a class="reference internal" href="modules/role.html#tbot.role.BoardUBoot" title="tbot.role.BoardUBoot"><code class="xref py py-class docutils literal notranslate"><span class="pre">tbot.role.BoardUBoot</span></code></a> machine first, run some commands
on it, and then take its console channel for itself.  This is what the
<a class="reference internal" href="modules/machine_board.html#tbot.machine.board.LinuxUbootConnector" title="tbot.machine.board.LinuxUbootConnector"><code class="xref py py-class docutils literal notranslate"><span class="pre">board.LinuxUbootConnector</span></code></a>
does.</p>
</li>
</ul>
</section>
<section id="configuring-a-lab-host">
<h2>Configuring a lab-host<a class="headerlink" href="#configuring-a-lab-host" title="Link to this heading">¶</a></h2>
<p>Here are some examples of lab-host configuration.  The first example just uses
the localhost but adjusts tbot’s working directory.  You could use this if the
default does not suit you.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tbot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tbot.machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">connector</span><span class="p">,</span> <span class="n">linux</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LocalLab</span><span class="p">(</span><span class="n">connector</span><span class="o">.</span><span class="n">SubprocessConnector</span><span class="p">,</span> <span class="n">linux</span><span class="o">.</span><span class="n">Bash</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">linux</span><span class="o">.</span><span class="n">Workdir</span><span class="o">.</span><span class="n">xdg_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;project-xyz&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register_machines</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">LocalLab</span><span class="p">,</span> <span class="p">[</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">LabHost</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">LocalHost</span><span class="p">])</span>
</pre></div>
</div>
<p>As this machine is also the localhost, we register it for
<a class="reference internal" href="modules/role.html#tbot.role.LocalHost" title="tbot.role.LocalHost"><code class="xref py py-class docutils literal notranslate"><span class="pre">tbot.role.LocalHost</span></code></a> as well.</p>
<p>The second example is a lab-host to which we need to connect with SSH:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tbot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tbot.machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">connector</span><span class="p">,</span> <span class="n">linux</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RemoteLab</span><span class="p">(</span><span class="n">connector</span><span class="o">.</span><span class="n">SSHConnector</span><span class="p">,</span> <span class="n">linux</span><span class="o">.</span><span class="n">Bash</span><span class="p">):</span>
     <span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;remote-lab.example.com&quot;</span>
     <span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;lab-user&quot;</span>
     <span class="n">port</span> <span class="o">=</span> <span class="mi">2222</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register_machines</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">RemoteLab</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">LabHost</span><span class="p">)</span>
</pre></div>
</div>
<p>Check the <a class="reference internal" href="modules/machine_connector.html#tbot.machine.connector.SSHConnector" title="tbot.machine.connector.SSHConnector"><code class="xref py py-class docutils literal notranslate"><span class="pre">connector.SSHConnector</span></code></a>
documentation for more details.</p>
</section>
<section id="configuring-a-board">
<span id="config-board"></span><h2>Configuring a board<a class="headerlink" href="#configuring-a-board" title="Link to this heading">¶</a></h2>
<p>The <a class="reference internal" href="quickstart.html#quickstart"><span class="std std-ref">Quick Start</span></a> guide already walks through this to some degree.  Here is
some more information.  The <a class="reference internal" href="modules/role.html#tbot.role.Board" title="tbot.role.Board"><code class="xref py py-class docutils literal notranslate"><span class="pre">tbot.role.Board</span></code></a> role describes just the
physical hardware.  In most situations this means a serial console and
(ideally) a controllable power supply.</p>
<section id="serial-console">
<h3>Serial Console<a class="headerlink" href="#serial-console" title="Link to this heading">¶</a></h3>
<p>The easiest way to access a serial console is to use the
<a class="reference internal" href="modules/machine_connector.html#tbot.machine.connector.ConsoleConnector" title="tbot.machine.connector.ConsoleConnector"><code class="xref py py-class docutils literal notranslate"><span class="pre">connector.ConsoleConnector</span></code></a>.
It just needs a command to open a serial console - commonly I use <a class="reference external" href="https://github.com/npat-efault/picocom">picocom</a>.
<a class="reference external" href="https://github.com/tio/tio">tio</a> might also be an interesting option.  Tools which do fancy screen
buffering like <em>minicom</em> or <em>screen</em> cannot be used here.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tbot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tbot.machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">connector</span><span class="p">,</span> <span class="n">board</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoard</span><span class="p">(</span><span class="n">connector</span><span class="o">.</span><span class="n">ConsoleConnector</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">Board</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mach</span><span class="p">):</span>
        <span class="c1"># mach is an open &quot;channel&quot; on the lab-host.  We can call the</span>
        <span class="c1"># console command on it using `open_channel()`.  The channel is then</span>
        <span class="c1"># returned.</span>
        <span class="k">return</span> <span class="n">mach</span><span class="o">.</span><span class="n">open_channel</span><span class="p">(</span><span class="s2">&quot;picocom&quot;</span><span class="p">,</span> <span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="s2">&quot;115200&quot;</span><span class="p">,</span> <span class="s2">&quot;/dev/ttyUSB0&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register_machines</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyBoard</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">Board</span><span class="p">)</span>
</pre></div>
</div>
<p>If the board is connected to your localhost, you can also use the
<a class="reference internal" href="contrib/connector.html#tbot_contrib.connector.pyserial.PyserialConnector" title="tbot_contrib.connector.pyserial.PyserialConnector"><code class="xref py py-class docutils literal notranslate"><span class="pre">PyserialConnector</span></code></a> from
<code class="xref py py-mod docutils literal notranslate"><span class="pre">tbot_contrib</span></code>.</p>
<p>Finally, if your board does not have a serial console, please take a look at
<a class="reference internal" href="#config-board-without-serial"><span class="std std-ref">Configuring a board without a serial console</span></a>.</p>
</section>
<section id="power-control">
<h3>Power Control<a class="headerlink" href="#power-control" title="Link to this heading">¶</a></h3>
<p>For real automation of the hardware, its power supply must be controllable or
there must be at least a way to trigger a hardware reset automatically.  In
either case, you can add this to the configuration using the
<a class="reference internal" href="modules/machine_board.html#tbot.machine.board.PowerControl" title="tbot.machine.board.PowerControl"><code class="xref py py-class docutils literal notranslate"><span class="pre">board.PowerControl</span></code></a> initializer:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tbot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tbot.machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">connector</span><span class="p">,</span> <span class="n">board</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoard</span><span class="p">(</span><span class="n">connector</span><span class="o">.</span><span class="n">ConsoleConnector</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">PowerControl</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">Board</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">poweron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">tbot</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">LabHost</span><span class="p">)</span> <span class="k">as</span> <span class="n">lh</span><span class="p">:</span>
            <span class="n">lh</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;sispmctl&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">poweroff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">tbot</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">LabHost</span><span class="p">)</span> <span class="k">as</span> <span class="n">lh</span><span class="p">:</span>
            <span class="n">lh</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;sispmctl&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">)</span>

    <span class="c1"># Time to wait between poweroff and subsequent poweron.  Use this if</span>
    <span class="c1"># your board needs time until power is truly off.</span>
    <span class="n">powercycle_delay</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mach</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mach</span><span class="o">.</span><span class="n">open_channel</span><span class="p">(</span><span class="s2">&quot;picocom&quot;</span><span class="p">,</span> <span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="s2">&quot;115200&quot;</span><span class="p">,</span> <span class="s2">&quot;/dev/ttyUSB0&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register_machines</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyBoard</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">Board</span><span class="p">)</span>
</pre></div>
</div>
<p>If you cannot provide full control but just a way to trigger a reset, it could
look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">poweron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tbot</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">LabHost</span><span class="p">)</span> <span class="k">as</span> <span class="n">lh</span><span class="p">:</span>
        <span class="n">lh</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;board-reset.sh&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">poweroff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Do nothing...</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>If nothing of that sort is possible, there are a few hacks that have proven to
work “well enough”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">poweron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate the human into the loop:  This will send a notification to the</span>
<span class="sd">    developer that they need to manually trigger a reset now:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">tbot</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">LocalHost</span><span class="p">)</span> <span class="k">as</span> <span class="n">lo</span><span class="p">:</span>
        <span class="n">lo</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;notify-send&quot;</span><span class="p">,</span> <span class="s2">&quot;Powercycle&quot;</span><span class="p">,</span> <span class="s2">&quot;Powercycle foo board please!&quot;</span><span class="p">)</span>
        <span class="n">tbot</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Powercycle now!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">poweron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This alternative tries to trigger a soft-reset by spamming various</span>
<span class="sd">    commands on the board console in hopes that one of them sticks.  It is</span>
<span class="sd">    not reliable at all but can be useful as an 80% kind of solution...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="c1"># try stopping any running program on the board&#39;s shell</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">sendcontrol</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="c1"># try rebooting from Linux</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;reboot&quot;</span><span class="p">)</span>
    <span class="c1"># ... or if you also use U-Boot, try resetting from there.  the `cat` is</span>
    <span class="c1"># used to ensure we don&#39;t send the `reset` to Linux as that messes with</span>
    <span class="c1"># the terminal...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;cat&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;reset&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="configuring-linux-for-a-board">
<span id="config-board-linux"></span><h2>Configuring Linux for a board<a class="headerlink" href="#configuring-linux-for-a-board" title="Link to this heading">¶</a></h2>
<p>Now that the “physical board” is configured, a second machine for the software
running on it is needed.  First, this section describes how to configure a
machine for a Linux system running on the board.</p>
<p>A “board software” machine is supposed to take the console channel from the
“physical board” machine.  To do this, there exists a special
<code class="xref py py-class docutils literal notranslate"><span class="pre">board.Connector</span></code>.  It will first
instanciate the “physical board” machine, then take exclusive access to it and
acquire its console channel.</p>
<p>From there, in most cases an initializer is needed which waits for the login
prompt and then logs in.  tbot provides the <a class="reference internal" href="modules/machine_board.html#tbot.machine.board.LinuxBootLogin" title="tbot.machine.board.LinuxBootLogin"><code class="xref py py-class docutils literal notranslate"><span class="pre">board.LinuxBootLogin</span></code></a> initializer for this.</p>
<p>Finally, the shell should be chosen according to the shell running on the
board.  tbot currently provides either <a class="reference internal" href="modules/machine_linux.html#tbot.machine.linux.Bash" title="tbot.machine.linux.Bash"><code class="xref py py-class docutils literal notranslate"><span class="pre">linux.Bash</span></code></a> or <code class="xref py py-class docutils literal notranslate"><span class="pre">linux.Ash</span></code>.
When in doubt, choose <code class="docutils literal notranslate"><span class="pre">Ash</span></code>.</p>
<p>Tying it all together, the configuration will look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tbot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tbot.machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">connector</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">linux</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoard</span><span class="p">(</span><span class="n">connector</span><span class="o">.</span><span class="n">ConsoleConnector</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">PowerControl</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">Board</span><span class="p">):</span>
    <span class="c1"># see above</span>
    <span class="o">...</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoardLinux</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">Connector</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">LinuxBootLogin</span><span class="p">,</span> <span class="n">linux</span><span class="o">.</span><span class="n">Ash</span><span class="p">):</span>
    <span class="c1"># for board.LinuxBootLogin:</span>
    <span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;hunter2&quot;</span>  <span class="c1"># or `None` if no password is needed</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register_machines</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyBoard</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">Board</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyBoardLinux</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">BoardLinux</span><span class="p">)</span>
</pre></div>
</div>
<p>This should be enough to get a scriptable Linux session on the board.  If your
system has a particularly noisy kernel which keeps clobbering the login prompt,
give the <a class="reference internal" href="modules/machine_board.html#tbot.machine.board.LinuxBootLogin.login_delay" title="tbot.machine.board.LinuxBootLogin.login_delay"><code class="xref py py-attr docutils literal notranslate"><span class="pre">login_delay</span></code></a>
setting a try.</p>
<p>It is often useful to run some commands directly after logging into Linux for
every testrun.  For example, to silence kernel log messages or to set some
environment variables:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyBoardLinux</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">Connector</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">LinuxBootLogin</span><span class="p">,</span> <span class="n">linux</span><span class="o">.</span><span class="n">Ash</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
    <span class="n">password</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># silence kernel log messages so they don&#39;t clobber the console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;sysctl&quot;</span><span class="p">,</span> <span class="s2">&quot;kernel.printk=2 2 2 2&quot;</span><span class="p">)</span>
        <span class="c1"># set PAGER* environment variables to prevent any kind of pager from</span>
        <span class="c1"># running as pagers are not well scriptable.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="s2">&quot;PAGER&quot;</span><span class="p">,</span> <span class="s2">&quot;cat&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="s2">&quot;SYSTEMD_PAGER&quot;</span><span class="p">,</span> <span class="s2">&quot;cat&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>That said, it is a good idea to keep this kind of initialization to a minimum.
In most cases, you will be better off performing such steps at the start of
each testcase which needs them instead.</p>
</section>
<section id="configuring-u-boot-for-a-board">
<span id="config-board-uboot"></span><h2>Configuring U-Boot for a board<a class="headerlink" href="#configuring-u-boot-for-a-board" title="Link to this heading">¶</a></h2>
<p>For lower level development, making U-Boot scriptable is often desirable.
Configuring a machine for U-Boot works much the same as with Linux. If your
board is configured to autoboot, you can use the
<a class="reference internal" href="modules/machine_board.html#tbot.machine.board.UBootAutobootIntercept" title="tbot.machine.board.UBootAutobootIntercept"><code class="xref py py-class docutils literal notranslate"><span class="pre">board.UBootAutobootIntercept</span></code></a>
initializer to stop it. For U-Boot interaction, there is a
<a class="reference internal" href="modules/machine_board.html#tbot.machine.board.UBootShell" title="tbot.machine.board.UBootShell"><code class="xref py py-class docutils literal notranslate"><span class="pre">board.UBootShell</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tbot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tbot.machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">connector</span><span class="p">,</span> <span class="n">board</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoard</span><span class="p">(</span><span class="n">connector</span><span class="o">.</span><span class="n">ConsoleConnector</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">PowerControl</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">Board</span><span class="p">):</span>
    <span class="c1"># see above</span>
    <span class="o">...</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoardUBoot</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">Connector</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">UBootAutobootIntercept</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">UBootShell</span><span class="p">):</span>
    <span class="c1"># U-Boot prompt string</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;=&gt; &quot;</span>

    <span class="c1"># if needed, you can set a different autoboot prompt (regex):</span>
    <span class="c1"># autoboot_prompt = tbot.Re(&quot;Press DEL 4 times.{0,100}&quot;, re.DOTALL)</span>
    <span class="c1"># ... and the appropriate key-sequence:</span>
    <span class="c1"># autoboot_keys = &quot;\x7f\x7f\x7f\x7f&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register_machines</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyBoard</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">Board</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyBoardUBoot</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">BoardUBoot</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="configuring-a-custom-linux-boot-sequence">
<h2>Configuring a custom Linux boot sequence<a class="headerlink" href="#configuring-a-custom-linux-boot-sequence" title="Link to this heading">¶</a></h2>
<p>Instead of waiting for Linux to boot automatically, you can use the U-Boot
configuration to boot into Linux using custom commands.  I use this a lot to
implement network boot on the fly.  It also means I can very easily customize
the boot-sequence without touching the target (for example with <a class="reference internal" href="cli.html#cli-flags"><span class="std std-ref">-f Flags</span></a>).</p>
<p>From a working U-Boot configuration, the
<a class="reference internal" href="modules/machine_board.html#tbot.machine.board.LinuxUbootConnector" title="tbot.machine.board.LinuxUbootConnector"><code class="xref py py-class docutils literal notranslate"><span class="pre">board.LinuxUbootConnector</span></code></a>
can be used to define a custom boot sequence:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tbot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tbot.machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">connector</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">linux</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoard</span><span class="p">(</span><span class="n">connector</span><span class="o">.</span><span class="n">ConsoleConnector</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">PowerControl</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">Board</span><span class="p">):</span>
    <span class="c1"># see above</span>
    <span class="o">...</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoardUBoot</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">Connector</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">UBootAutobootIntercept</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">UBootShell</span><span class="p">):</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;=&gt; &quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoardLinux</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">LinuxUbootConnector</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">LinuxBootLogin</span><span class="p">,</span> <span class="n">linux</span><span class="o">.</span><span class="n">Ash</span><span class="p">):</span>
    <span class="c1"># for board.LinuxBootLogin:</span>
    <span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;hunter2&quot;</span>

    <span class="c1"># for board.LinuxUbootConnector:</span>
    <span class="n">uboot</span> <span class="o">=</span> <span class="n">MyBoardUBoot</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_boot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ub</span><span class="p">):</span>  <span class="c1"># &lt;- ub is the instance of MyBoardUBoot</span>
        <span class="n">ub</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="s2">&quot;autoload&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span>
        <span class="n">ub</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;dhcp&quot;</span><span class="p">)</span>
        <span class="n">loadaddr</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">ram_base</span> <span class="o">+</span> <span class="mh">0x02000000</span>
        <span class="n">ub</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;tftp&quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">loadaddr</span><span class="p">),</span> <span class="s2">&quot;1.2.3.4:my-board/fitImage&quot;</span><span class="p">)</span>
        <span class="n">bootargs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;root=/dev/nfs&quot;</span><span class="p">,</span> <span class="s2">&quot;nfsroot=...&quot;</span><span class="p">,</span> <span class="s2">&quot;ip=dhcp&quot;</span><span class="p">]</span>
        <span class="n">ub</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="s2">&quot;bootargs&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bootargs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ub</span><span class="o">.</span><span class="n">boot</span><span class="p">(</span><span class="s2">&quot;bootm&quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">loadaddr</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register_machines</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyBoard</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">Board</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyBoardUBoot</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">BoardUBoot</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyBoardLinux</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">BoardLinux</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="configuring-a-board-without-a-serial-console">
<span id="config-board-without-serial"></span><h2>Configuring a board without a serial console<a class="headerlink" href="#configuring-a-board-without-a-serial-console" title="Link to this heading">¶</a></h2>
<p>Maybe you have a board which does not have a hardware serial.  You can only
access it via SSH, for example.  tbot can still be used with such a setup.
In this case, the board machine should use the
<code class="xref py py-class docutils literal notranslate"><span class="pre">connector.NullConnector</span></code>.
It fills in the connector role but will raise an error if there are any
attempts to actually access the console.</p>
<p>From there, a Linux machine with a custom connection scheme is needed. It needs to:</p>
<ol class="arabic simple">
<li><p>Instantiate the board machine to power it on.  Ideally it should also get
“hardware information” from it like the IP-address.</p></li>
<li><p>Wait for the device to show up.</p></li>
<li><p>Use the <a class="reference internal" href="modules/machine_connector.html#tbot.machine.connector.SSHConnector" title="tbot.machine.connector.SSHConnector"><code class="xref py py-class docutils literal notranslate"><span class="pre">connector.SSHConnector</span></code></a> to connect to it.</p></li>
</ol>
<p>As these steps need to happen before the connector, it is best to implement
them as a <a class="reference internal" href="modules/machine.html#tbot.machine.PreConnectInitializer" title="tbot.machine.PreConnectInitializer"><code class="xref py py-class docutils literal notranslate"><span class="pre">PreConnectInitializer</span></code></a>.</p>
<p>Here is a code sample for this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tbot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tbot.machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">board</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">linux</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoard</span><span class="p">(</span><span class="n">connector</span><span class="o">.</span><span class="n">NullConnector</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">PowerControl</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">Board</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">poweron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">tbot</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">LabHost</span><span class="p">)</span> <span class="k">as</span> <span class="n">lh</span><span class="p">:</span>
            <span class="n">lh</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;sispmctl&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">poweroff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">tbot</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">LabHost</span><span class="p">)</span> <span class="k">as</span> <span class="n">lh</span><span class="p">:</span>
            <span class="n">lh</span><span class="o">.</span><span class="n">exec0</span><span class="p">(</span><span class="s2">&quot;sispmctl&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">)</span>

    <span class="n">ip_address</span> <span class="o">=</span> <span class="s2">&quot;192.168.1.100&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoardWaitForSsh</span><span class="p">(</span><span class="n">tbot</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">PreConnectInitializer</span><span class="p">):</span>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_init_pre_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">tbot</span><span class="o">.</span><span class="n">ctx</span><span class="p">()</span> <span class="k">as</span> <span class="n">cx</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">cx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">Board</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">b</span>
            <span class="n">lh</span> <span class="o">=</span> <span class="n">cx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">LabHost</span><span class="p">)</span>
            <span class="n">tbot</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Waiting for SSH server...&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">lh</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="s2">&quot;ssh&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;BatchMode=yes&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;root@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># now hand over to the SSHConnector</span>
            <span class="k">yield</span> <span class="kc">None</span>
            <span class="n">lh</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="s2">&quot;ps&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBoardLinux</span><span class="p">(</span><span class="n">MyBoardWaitForSsh</span><span class="p">,</span> <span class="n">connector</span><span class="o">.</span><span class="n">SSHConnector</span><span class="p">,</span> <span class="n">linux</span><span class="o">.</span><span class="n">Ash</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hostname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">ip_address</span>

    <span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register_machines</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyBoard</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">Board</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyBoardLinux</span><span class="p">,</span> <span class="n">tbot</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">BoardLinux</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
    <a href="https://github.com/Rahix/tbot">
        <img style="position: absolute; top: 0; right: 0; border: 0;" decoding="async" width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" loading="lazy" data-recalc-dims="1">
    </a>

          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="cli.html" class="btn btn-neutral float-left" title="tbot CLI" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="recipes.html" class="btn btn-neutral float-right" title="Recipes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Rahix.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>